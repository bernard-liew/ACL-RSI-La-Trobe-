---
title: "2-analysis"
author: "bernard-liew"
date: "2021-02-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Load package

```{r message=FALSE, warning=FALSE}
# Helper
library (tidyverse)
library (arsenal)
library (cowplot)

# Modelling
library (huge)
library (bootnet)
library (qgraph)
library (factoextra)
library (FactoMineR)
library (NetworkComparisonTest)

```

# Import 

```{r}
df <- readRDS ("output/dat_acl.RDS")
df <- df %>%
  mutate (rts_6binary = ifelse (rts_6 %in% c(NA, "na_no_prior", "no"), "no", "yes"),
          rts_12binary = ifelse (rts_12 %in% c("no", "yes_lower"), "no", "yes"))
```

# Network analysis

## Preprocess

```{r message=FALSE, warning=FALSE}

net_analysis <- function (data, follow_up = "_6", n_boot = 10, subgroup_var = rts_6binary, subgroup = "no") {
  
  # Select rsi at 6th mth
  mat <- data %>%
    filter ({{subgroup_var}}  %in% subgroup) %>%
    select (matches (follow_up)) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))
  
  var_names <- names (mat)
  
  names(mat) <- paste0("q", 1:ncol (mat))
  
  
  #Normalize data
  mat.npn <- huge.npn(mat)

  stats_type <- c("edge", "strength", "betweenness", "expectedInfluence", "closeness")
  
  nw <- estimateNetwork(mat.npn,
                         default="EBICglasso",
                         corMethod = "cor",
                          tuning = 0.5,
                          lambda.min.ratio = 0.001,
                          corArgs =
                            list(method = "pearson",
                                 use = "pairwise.complete.obs"))
  
  centr <- centralityTable (nw)
  
  centr_stb <- bootnet (nw,
                        nBoots = n_boot ,
                        type = "case",
                        statistics = stats_type,
                        verbose = FALSE)
  
  cor_stb <- corStability(centr_stb)
  
  edgewts <- bootnet (nw,
                      nBoots = n_boot ,
                      verbose = FALSE)
  
  return (list (mat = mat,
                nw = nw,
                centr = centr,
                centr_stb = centr_stb,
                cor_stb = cor_stb,
                edgewts = edgewts,
                var_names = var_names))
  
}

res <- list ()

res$mth6_rts12no <- net_analysis (data = df, 
                          follow_up = "_6", 
                          subgroup_var = rts_12binary, 
                          subgroup = "no", 
                          n_boot = 1000)

res$mth6_rts12yes <- net_analysis (data = df, 
                          follow_up = "_6", 
                          subgroup_var = rts_12binary, 
                          subgroup = "yes", 
                          n_boot = 1000)

res$mth12_rts12no <- net_analysis (data = df, 
                          follow_up = "_12", 
                          subgroup_var = rts_12binary, 
                          subgroup = "no", 
                          n_boot = 1000)

res$mth12_rts12yes <- net_analysis (data = df, 
                          follow_up = "_12", 
                          subgroup_var = rts_12binary, 
                          subgroup = "yes", 
                          n_boot = 1000)

res$mth6 <- net_analysis (data = df, 
                          follow_up = "_6", 
                          subgroup_var = rts_12binary, 
                          subgroup = c("no", "yes"), 
                          n_boot = 1000)

res$mth12 <- net_analysis (data = df, 
                          follow_up = "_12", 
                          subgroup_var = rts_12binary, 
                          subgroup = c("no", "yes"), 
                          n_boot = 1000)

```

## Results

### Plot network

Blue edges - positive correlation

Red edges - negative correlation

The thickness of the edges indicate the magnitude of correlation.

```{r message=FALSE, warning=FALSE}

nodenames <- str_remove (res$mth6_rts12no$var_names, "_6")

par(mfrow= c(2,3))
# Visualize network
p1 <- plot (res$mth6_rts12no$nw, 
            title = "6mo_noRTS12", 
            label.cex = 1.5, 
            vsize = 10, 
            curve = 0.4, 
            curveAll = TRUE,
            nodeNames = nodenames)
plot (res$mth6_rts12yes$nw, title = "6mo_yesRTS12", 
      layout = p1$layout, 
      label.cex = 1.5, 
      vsize = 10, 
      curve = 0.4,
      curveAll = TRUE,
      nodeNames = nodenames)
plot (res$mth12_rts12no$nw, title = "12mo_noRTS12", 
      layout = p1$layout, 
      label.cex = 1.5, 
      vsize = 10, 
      curve = 0.4,
      curveAll = TRUE,
      nodeNames = nodenames)
plot (res$mth12_rts12yes$nw, title = "12mo_yesRTS12", 
      layout = p1$layout, 
      label.cex = 1.5, 
      vsize = 10, 
      curve = 0.4,
      curveAll = TRUE,
      nodeNames = nodenames)

plot (res$mth6$nw, title = "6mo", 
      layout = p1$layout, 
      label.cex = 1.5, 
      vsize = 10, 
      curve = 0.4,
      curveAll = TRUE,
      nodeNames = nodenames)
plot (res$mth12$nw, title = "12mo", 
      layout = p1$layout, 
      label.cex = 1.5, 
      vsize = 10, 
      curve = 0.4,
      curveAll = TRUE,
      nodeNames = nodenames)
```

### Plot edge weights stability

95%CI of different edge weights that do not overlap are significantly different

```{r message=FALSE, warning=FALSE}

w_fig <- list() 

w_fig$mth6 <- plot (res$mth6$edgewts, order = "sample", CIstyle = "SE")
w_fig$mth12 <- plot (res$mth12$edgewts, order = "sample", CIstyle = "SE")

w_fig <- map (w_fig, ~.x + 
                  theme(text = element_text(size = 16)), 
              include = "all", print = FALSE, scale = "relative")

cowplot::plot_grid(plotlist = w_fig, labels = c("6mth","12mth"), vjust = 1, hjust = -1, ncol = 2, nrow = 1)


```


### Plot centrality

High centrality nodes have strong connections to many other nodes, and act as hubs that connect otherwise disparate nodes to one another.

Low centrality nodes exist on the periphery of the network, with fewer and weaker connections to other nodes of the network.

Strength is the sum of the absolute value of its connections with other nodes in the network.

Degree can be straightforwardly generalized to weighted networks by considering the sum of the weights of the connections (in absolute value), instead of their number. This generalization is called strength.

Closeness centrality is defined as the inverse of the sum of the distances of the focal node from all the other nodes in the network. Closeness is the average shortest path between a given node and the remaining nodes in the network. Nodes with higher closeness are more proximally connected to the rest of the network.

Betweenness is the number of times in which a given node lies on the shortest path between two other nodes.

The greater the value of centrality indices to one, the more important the variable.

```{r message=FALSE, warning=FALSE}

c_fig <- list () 

c_fig$mth6 <- centralityPlot (res$mth6$nw, include = c("Strength", "Closeness", "Betweenness"), scale = "relative")
c_fig$mth12 <- centralityPlot (res$mth12$nw, include = c("Strength", "Closeness", "Betweenness"), scale = "relative")

c_fig <- c_fig %>%
  map (~.x + 
                  scale_x_continuous(breaks= c(0, 0.5, 1), lim = c(0, 1)) + 
                  theme(text = element_text(size = 20), 
                        axis.text.x = element_text(angle = 45, hjust = 1)), 
              include = "all", print = FALSE, scale = "relative")

#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_strength.tiff")
cowplot::plot_grid(plotlist = c_fig, labels = c("6mth","12mth"), vjust = 1, hjust = -1, ncol = 2, nrow = 1)
```

### Plot centrality stability

```{r message=FALSE, warning=FALSE}
# Centrality stability
plot (res$mth6$centr_stb, statistics = c("closeness", "strength", "betweenness"))
plot (res$mth12$centr_stb, statistics = c("closeness", "strength", "betweenness"))
```

## Compare networks

```{r}
pair_res <- NCT (res$mth6$nw, 
             res$mth12$nw,
             it = 1000,
             paired = TRUE,
             test.edges = TRUE,
             progressbar = FALSE,
             test.centrality = TRUE,
             p.adjust.methods = "none",
             centrality = c("closeness", "strength", "betweenness"))
```


# Clustering

## Preprocess
```{r}
mat <- scale(mat)
```

## Get distance measure

```{r}
mat_dist <- dist(mat, method = "euclidean")
fviz_dist(mat_dist)

res.hc <- hclust(d = mat_dist, method = "ward.D2")
# Compute cophentic distance
res.coph <- cophenetic(res.hc)

# Correlation between cophenetic distance and
# the original distance
cor(mat_dist, res.coph)

```

## Optimal clusters

```{r}
# Elbow method
 fviz_nbclust(mat, kmeans, method = "wss") +
    geom_vline(xintercept = 4, linetype = 2)+
  labs(subtitle = "Elbow method")

# Silhouette method
fviz_nbclust(mat, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap statistic
# nboot = 50 to keep the function speedy. 
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
set.seed(123)
fviz_nbclust(mat, kmeans, nstart = 25,  method = "gap_stat", nboot = 50)+
  labs(subtitle = "Gap statistic method")
```

## Cut tree and visualize
```{r warning=FALSE}

cut_n <- 4

grp <- cutree(res.hc, k = cut_n )

# Cut in 4 groups and color by groups
fviz_dend(res.hc, k = cut_n, # Cut in four groups
          cex = 0.5, # label size
          k_colors = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),
          color_labels_by_k = TRUE, # color labels by groups
          rect = TRUE)


fviz_cluster(list(data = mat, cluster = grp),
             axes = 1:2,
          palette = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),
          ellipse.type = "convex", # Concentration ellipse
          repel = TRUE, # Avoid label overplotting (slow)
          show.clust.cent = FALSE, ggtheme = theme_minimal())
```

## Understand clusters

```{r, results = "asis"}
df_grp <- df %>%
  select (subj, dob, sex, graft, matches ("pre_|aclrsi|rts"))
df_grp$clus <- factor (grp)



tableby(clus ~ sex + pre_sports_level + pre_sports_freq + rts_exp + aclrsi_6 + aclrsi_12 + rts_12 + rts_6,
        data = na.omit (df_grp)) %>%
  summary ()
```

