---
title: "2-analysis"
author: "bernard-liew"
date: "2021-02-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Load package

```{r message=FALSE, warning=FALSE}
# Helper
library (tidyverse)
library (arsenal)
library (cowplot)

# Modelling
library (huge)
library (bootnet)
library (qgraph)
library (NetworkComparisonTest)
library (EGAnet)

# Parallel
library (furrr)

# Styling
library (kableExtra)

```

# Import 

Binarize `rts_6` and `rts_12`.

`rts_6` = `"no"` if either missing `NA`, `"na_no_prior"` or `"no"`. Everything else is `"yes"`.

`rts_12` = `"no"` if either missing `"no"`, or `"yes_lower"`. Everything else is `"yes"`.
```{r}
df <- readRDS ("output/dat_acl.RDS") %>%
  mutate (rts_6binary = ifelse (rts_6 %in% c("na_no_prior", "no"), "no", 
                                ifelse (rts_6 %in% c("NA"), "na", "yes")),
          rts_12binary = ifelse (rts_12 %in% c("no", "yes_lower"), "no", "yes"))


```

```{r, include = FALSE}
res <- readRDS ("output/nw_res.RDS")

sf <- paste0("q", c(1,2,3,5,6,7)) 
node_col <- ifelse (names (res$data[[1]]) %in% sf, "lightblue", "white")
```


# Network analysis

## Create datasets

```{r message=FALSE, warning=FALSE, eval = FALSE}
# 6th month RSI data
dat1 <- df%>%
    select (matches ("_6")) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))
# 12th month RSI data
dat2 <- df%>%
    select (matches ("_12")) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))
# 6th month RSI data on subgroup RTS at 6mo = no
dat3 <- df%>%
    filter (rts_6binary != "na") %>%
    filter (rts_6binary == "no") %>%
    select (matches ("_6")) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))
# 6th month RSI data on subgroup RTS at 6mo = yes
dat4 <- df %>%
    filter (rts_6binary != "na") %>%
    filter (rts_6binary == "yes") %>%
    select (matches ("_6")) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))
# 12th month RSI data on subgroup RTS at 12mo = no
dat5 <- df%>%
    filter (rts_12binary == "no") %>%
    select (matches ("_12")) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))
# 12th month RSI data on subgroup RTS at 12mo = yes
dat6 <- df%>%
    filter (rts_12binary == "yes") %>%
    select (matches ("_12")) %>%
    select (!matches ("ax_6m|ax_12m|aclrsi|rts_"))

var_names <- str_remove (names (dat1), "_6")
names(dat1) <- names(dat2) <- names(dat3) <- names(dat4) <- names(dat5) <- names(dat6) <- paste0("q", 1:ncol (dat1))

res <- tibble (subgrp = c(1:6),
               id = c("6mo", "12mo", "6moNo", "6moYes", "12moNo", "12moYes"),
               data =  list (dat1, dat2, dat3, dat4, dat5, dat6))

```

## Perform analysis

```{r, eval = FALSE}
B <- 1000
plan (multisession)
stats_type <- c("strength", "betweenness", "closeness")

res <- res %>%
  mutate (dat_norm = map (data, huge.npn)) %>%
  mutate (nw = map (dat_norm, estimateNetwork,
                         default="EBICglasso",
                         corMethod = "cor",
                          tuning = 0.5,
                          lambda.min.ratio = 0.001,
                          corArgs =
                            list(method = "pearson",
                                 use = "pairwise.complete.obs"))) %>%
  # Get centrality measures
  mutate (centr = map (nw, centralityTable)) %>%
  mutate (centr_stb = future_map (nw, 
                                  bootnet, 
                                  nBoots = B,
                                  type = "case",
                                  statistics = stats_type,
                                  .options = furrr_options(seed = TRUE))) %>%
  mutate (cor_stb = map (centr_stb,
                         corStability)) %>%
  mutate (edgewts = future_map (nw, 
                                bootnet, 
                                nBoots = B,
                                .options = furrr_options(seed = TRUE)))
   
saveRDS(res,
        "output/nw_res.RDS")  
```



## Results

### Plot network

**Blue edges** - positive correlation. **Red edges **- negative correlation.

The thickness of the edges indicate the magnitude of correlation.

```{r, include = FALSE}
var_table <- data.frame(nodes = paste0("q", 1:12))

qn <- c("Are you confident that you can perform at your previous level of sport participation?",
        "Do you think you are likely to re-injury your knee by participating in your sport?",
        "Are you nervous about playing your sport?",
        "Are you confident that your knee will not give way by playing your sport?",
        "Are you confident that you could play your sport without concern for your knee?",
        "Do you find it frustrating to have to consider your knee with respect to your sport?",
        "Are you fearful of re-injuring your knee by playing your sport?",
        "Are you confident about your knee holding up under pressure?",
        "Are you afraid of accidentally injuring your knee by playing your sport?",
        "Do thoughts of having to go through surgery and rehabilitation prevent you from playing your sport?",
        "Are you confident about your ability to perform well at your sport?",
        "Do you feel relaxed about playing your sport?")

var_table$qn <- qn

var_table %>%
  kable () %>%
  kable_styling()
```


```{r message=FALSE, warning=FALSE, fig.height=9, fig.width=9}

par(mfrow= c(3,2))
# Visualize network
p1 <- plot (res$nw[[1]], title = res$id[[1]], label.cex = 1.5, 
            vsize = 10, curve = 0.4, curveAll = TRUE, color = node_col)
plot (res$nw[[2]], title = res$id[[2]], layout = p1$layout, label.cex = 1.5,
      vsize = 10, curve = 0.4, curveAll = TRUE, color = node_col)
plot (res$nw[[3]], title = res$id[[3]], layout = p1$layout, label.cex = 1.5, 
      vsize = 10, curve = 0.4, curveAll = TRUE, color = node_col)
plot (res$nw[[4]], title = res$id[[4]], layout = p1$layout, label.cex = 1.5, 
      vsize = 10, curve = 0.4, curveAll = TRUE, color = node_col)
plot (res$nw[[5]], title = res$id[[5]], layout = p1$layout, label.cex = 1.5, 
      vsize = 10, curve = 0.4, curveAll = TRUE, color = node_col)
plot (res$nw[[6]], title = res$id[[6]], layout = p1$layout, label.cex = 1.5, 
      vsize = 10, curve = 0.4, curveAll = TRUE, color = node_col)
```

### Plot edge weights stability

95% CI of different edge weights that do not overlap are significantly different

```{r message=FALSE, warning=FALSE, fig.height=25, fig.width=9}

w_fig <- map (res$edgewts, plot, order = "sample", CIstyle = "SE")

w_fig <- map (w_fig, ~.x + 
                  theme(text = element_text(size = 16)), 
              include = "all", print = FALSE, scale = "relative")

cowplot::plot_grid(plotlist = w_fig, labels = res$id, vjust = 1, hjust = -1, ncol = 2, nrow = 3)


```


### Plot centrality

**High centrality** nodes have strong connections to many other nodes, and act as hubs that connect otherwise disparate nodes to one another. **Low centrality** nodes exist on the periphery of the network, with fewer and weaker connections to other nodes of the network.

**Strength** is the sum of the absolute value of its connections with other nodes in the network.

**Closeness** centrality is defined as the inverse of the sum of the distances of the focal node from all the other nodes in the network. Closeness is the average shortest path between a given node and the remaining nodes in the network. Nodes with higher closeness are more proximally connected to the rest of the network.

**Betweenness** is the number of times in which a given node lies on the shortest path between two other nodes.

The greater the value of centrality indices to one, the more important the variable.

```{r message=FALSE, warning=FALSE, fig.height=15, fig.width=9}

c_fig <- map (res$nw, centralityPlot, include = c("Closeness", "Strength", "Betweenness"),  
              print = FALSE, scale = "relative") %>%
  map (~.x + 
                  scale_x_continuous(breaks= c(0, 0.5, 1), lim = c(0, 1)) + 
                  theme(text = element_text(size = 20), 
                        axis.text.x = element_text(angle = 45, hjust = 1)), 
              include = "all", print = FALSE, scale = "relative")

#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_strength.tiff")
cowplot::plot_grid(plotlist = c_fig,  labels = res$id, vjust = 1, hjust = 0, ncol = 2, nrow = 3)
#dev.off()
```

### Plot centrality stability

```{r message=FALSE, warning=FALSE, fig.height=15, fig.width=9}
# Plot centrality stability
s_fig <- map (res$centr_stb, plot, statistics = c("closeness", "strength", "betweenness"))

s_fig <- map (s_fig, ~.x + 
                ylab ("Ave Corr") + 
                  theme(text = element_text(size = 20), 
                        axis.text.x = element_text(angle = 90, hjust = 1)), 
              include = "all", print = FALSE, scale = "relative")


#tiff(width = 15, height = 15, units = "in", res = 100, file = "output/odi_stability.tiff")
cowplot::plot_grid(plotlist = s_fig, labels = res$id, vjust = 1, hjust = 0, ncol = 2, nrow = 3)
#dev.off()
```

## Exploratory graphical analysis

```{reval = FALSE}
res <- res %>%
  mutate (ega = map (dat_norm, 
                     EGA, 
                     cor = "pearson",
                     model = "glasso",
                     model.args = list (tuning = 0.5,
                      lambda.min.ratio = 0.001,
                      corArgs =
                        list(method = "pearson",
                             use = "pairwise.complete.obs")),
                     algorithm = "walktrap",
                     plot.EGA = FALSE)) %>%
  mutate (cfa = pmap (list (ega.obj = ega, 
                            data = dat_norm),
                      CFA,
                      estimator = "WLSMV",
                      plot.CFA = FALSE)) 

# Bootstrap
ega_boot <- vector("list", length (res$id))
for (n in seq_along (res$id)) {
  
  ega_boot[[n]] <- bootEGA (res$dat_norm [[n]],
                             iter = 1000,
                             type = "resampling",
                             cor = "pearson",
                             model = "glasso",
                             algorithm = "walktrap",
                             plot.EGA = FALSE)
}
res$ega_boot <- ega_boot

```

## Report EGA

```{r, fig.height=12, fig.width=9}
node_font_size <- 1.5
circle_size <- 12
title_font_size <- 1.5
legend_font_size <- 3

par (mfrow = c(3,2))
qgraph (res$ega[[1]]$network, groups = as.factor (res$ega[[1]]$wc), title = "6mo", layout = p1$layout, label.cex = node_font_size, vsize = circle_size, shape = "circle", title.cex = title_font_size)
qgraph (res$ega[[2]]$network, groups = as.factor (res$ega[[2]]$wc), title = "12mo", layout = p1$layout, label.cex = node_font_size, vsize = circle_size, shape = "circle", title.cex = title_font_size)
qgraph (res$ega[[3]]$network, groups = as.factor (res$ega[[3]]$wc),title = "6mo No", layout = p1$layout, label.cex = node_font_size, vsize = circle_size, shape = "circle", title.cex = title_font_size)
qgraph (res$ega[[4]]$network, groups = as.factor (res$ega[[4]]$wc),title = "6m Yes", layout = p1$layout, label.cex = node_font_size, vsize = circle_size, shape = "circle", title.cex = title_font_size)
qgraph (res$ega[[3]]$network, groups = as.factor (res$ega[[5]]$wc),title = "12mo No", layout = p1$layout, label.cex = node_font_size, vsize = circle_size, shape = "circle", title.cex = title_font_size)
qgraph (res$ega[[4]]$network, groups = as.factor (res$ega[[6]]$wc),title = "12m Yes", layout = p1$layout, label.cex = node_font_size, vsize = circle_size, shape = "circle", title.cex = title_font_size)

```

## Stability

```{r, eval = FALSE}
ega_boot_stb <- vector("list", length (res$id))

for (n in seq_along (res$id)) {
  
  ega_boot_stb[[n]] <- dimStability (res$ega_boot[[n]], orig.wc = res$ega[[n]]$wc)
}

res$ega_boot_stb <- ega_boot_stb
```

### Summary table

```{r}

sum_df <- list()

for (n in seq_along (res$id)) {
  
  sum_df[[n]] <- res$ega_boot[[n]]$summary.table
}


sum_df <- bind_rows(sum_df) %>%
  mutate_if (is.numeric, round, 2)

sum_df$id <- res$id


sum_df
```

### Frequency 

```{r}
boot_freq <- res$ega_boot %>%
  map (pluck, "frequency") %>%
  map (as.data.frame)

names (boot_freq) <- res$id
boot_freq <-  bind_rows(boot_freq, .id = "id") 

boot_freq
```

## Compare networks

### Compare the networks for the RSI at 6th and 12th months

```{r, message=FALSE, warning=FALSE}
pair_res <- NCT (res$nw[[1]], 
             res$nw[[2]],
             it = 1000,
             paired = TRUE,
             test.edges = TRUE,
             progressbar = FALSE,
             test.centrality = TRUE,
             p.adjust.methods = "none",
             centrality = c("closeness", "strength", "betweenness"))
```


#### Edges which are different between networks

```{r}
pair_res$einv.pvals %>%
  filter (`p-value` < 0.05)
```

#### Centralities which are different between networks

```{r}
pair_res$diffcen.pval %>%
  as.data.frame() %>%
  filter_all (any_vars(. < 0.05))
```

### Compare the networks for the RSI at 6th month for those whose RTS value at 6mo was no vs yes

```{r, message=FALSE, warning=FALSE}
pair_res <- NCT (res$nw[[3]], 
             res$nw[[4]],
             it = 1000,
             paired = FALSE,
             test.edges = TRUE,
             progressbar = FALSE,
             test.centrality = TRUE,
             p.adjust.methods = "none",
             centrality = c("closeness", "strength", "betweenness"))
```


#### Edges which are different between networks

```{r}
pair_res$einv.pvals %>%
  filter (`p-value` < 0.05)
```

#### Centralities which are different between networks

```{r}
pair_res$diffcen.pval %>%
  as.data.frame() %>%
  filter_all (any_vars(. < 0.05))
```

### Compare the networks for the RSI at 12th month for those whose RTS value at 12mo was no vs yes

```{r, message=FALSE, warning=FALSE}
pair_res <- NCT (res$nw[[5]], 
             res$nw[[6]],
             it = 1000,
             paired = FALSE,
             test.edges = TRUE,
             progressbar = FALSE,
             test.centrality = TRUE,
             p.adjust.methods = "none",
             centrality = c("closeness", "strength", "betweenness"))

```


#### Edges which are different between networks

```{r}
pair_res$einv.pvals %>%
  filter (`p-value` < 0.05)
```

#### Centralities which are different between networks

```{r}
pair_res$diffcen.pval %>%
  as.data.frame() %>%
  filter_all (any_vars(. < 0.05))
```
